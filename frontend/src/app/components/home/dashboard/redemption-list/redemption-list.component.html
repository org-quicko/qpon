<div class="overflow-hidden mb-4">
  <div class="flex items-center mat-body-medium gap-[4px] text-on-surface">
    <div class="cursor-pointer" (click)="onNavigateToDashboard()">Dashboard</div>
    <mat-icon class="!text-[20px] !leading-none mt-1">navigate_next</mat-icon>
    <div class="cursor-pointer max-w-[100px] truncate">
      Redemptions
    </div>

  </div>
</div>


<div class="flex flex-col gap-3">
  <div class="flex items-center justify-between w-full">
    <div class="mat-headline-medium text-on-surface">
      Redemptions
    </div>

    <div>
      <app-date-range-filter></app-date-range-filter>
    </div>
  </div>

  <!-- Search -->
  <div class="flex items-center gap-[10px] w-full border rounded-[4px] h-[56px] border-outline-variant">
    <div class="h-[48px] w-[48px] flex justify-center items-center">
      <mat-icon class="text-on-surface-variant">search</mat-icon>
    </div>

    <input matInput [formControl]="searchControl"
      class="focus:outline-none align-middle py-[4px] w-full mat-body-large text-on-surface placeholder:text-outline"
      placeholder="Search customer by email" />
  </div>

  <!-- Table -->
  <div class="border-[1px] rounded-[5px] border-outline-variant overflow-hidden">
    <table mat-table [dataSource]="datasource" matSort [matSortActive]="sortOptions().active"
      [matSortDirection]="sortOptions().direction" matSortDisableClear="true" (matSortChange)="onSortChange($event)"
      class="table-fixed w-full">
      <!-- Applied At -->
      <ng-container matColumnDef="appliedAt">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="px-6 py-4 text-on-surface-variant">
          Applied at
        </th>

        <td mat-cell *matCellDef="let redemption" class="p-6">
          @if (isLoading()) {
          <ngx-skeleton-loader [theme]="{
                height: '24px',
                width: '120px',
                margin: '0'
              }"></ngx-skeleton-loader>
          } @else {
          <div class="flex flex-col leading-tight">
            <span>{{ redemption.getRedeemedAt() | date : 'hh:mm a' }}</span>

            <span class="text-sm text-on-surface-variant">
              {{ redemption.getRedeemedAt() | date : 'd MMM, y' }}
            </span>
          </div>
          }
        </td>
      </ng-container>

      <!-- Customer -->
      <ng-container matColumnDef="customer">
        <th mat-header-cell *matHeaderCellDef class="px-6 py-4 text-on-surface-variant">Customer</th>

        <td mat-cell *matCellDef="let redemption" class="p-6">
          @if (isLoading()) {
          <ngx-skeleton-loader [theme]="{
                height: '24px',
                width: '160px',
                margin: '0'
              }"></ngx-skeleton-loader>
          } @else {
          <div class="flex items-start cursor-pointer group"
            (click)="copyToClipboard(redemption.getCustomerEmail(), 'email address')">

            <div class="flex flex-col min-w-0">
              <!-- Customer Name -->
              <div class="font-body-large text-on-surface">
                {{ redemption.getCustomerName() }}
              </div>

              <!-- Email + Copy Icon Row -->
              <div class="flex items-center min-w-0">
                <div class="text-sm font-body-small text-on-surface-variant truncate max-w-[180px]">
                  {{ redemption.getCustomerEmail() }}
                </div>

                <!-- Copy Icon -->
                <button class="opacity-0 group-hover:opacity-100 transition-opacity duration-150 
               text-on-surface-variant hover:text-primary flex-shrink-0 ml-1"
                  (click)="$event.stopPropagation(); copyToClipboard(redemption.getCustomerEmail(), 'email address')">

                  <mat-icon class="material-symbols-outlined text-[16px] h-[16px]">
                    content_copy
                  </mat-icon>
                </button>
              </div>
            </div>

          </div>
          }
        </td>
      </ng-container>

      <!-- Coupon -->
      <ng-container matColumnDef="coupon">
        <th mat-header-cell *matHeaderCellDef class="px-6 py-4 text-on-surface-variant">Coupon code</th>

        <td mat-cell *matCellDef="let redemption" class="p-6">
          @if (isLoading()) {
          <ngx-skeleton-loader [theme]="{
                height: '24px',
                width: '100px',
                margin: '0'
              }"></ngx-skeleton-loader>
          } @else {
          <div class="flex items-center gap-2 cursor-pointer group"
            (click)="copyToClipboard(redemption.getCouponCode(), 'coupon code')">
            <span class="font-medium">{{ redemption.getCouponCode() }}</span>

            <button
              class="opacity-0 group-hover:opacity-100 transition-opacity duration-150 text-on-surface-variant hover:text-primary"
              (click)="
      $event.stopPropagation();
      copyToClipboard(redemption.getCouponCode(), 'coupon code')
    ">
              <mat-icon class="material-symbols-outlined text-[16px] h-[16px] w-[16px]">
                content_copy
              </mat-icon>
            </button>
          </div>
          }
        </td>
      </ng-container>

      <!-- Item -->
      <ng-container matColumnDef="item">
        <th mat-header-cell *matHeaderCellDef class="px-6 py-4 text-on-surface-variant">Item</th>

        <td mat-cell *matCellDef="let redemption" class="p-6">
          @if (isLoading()) {
          <ngx-skeleton-loader [theme]="{
                height: '24px',
                width: '80px',
                margin: '0'
              }"></ngx-skeleton-loader>
          } @else {
          {{ redemption.getItemName() }}
          }
        </td>
      </ng-container>

      <!-- Sales -->
      <ng-container matColumnDef="sales">
        <th mat-header-cell *matHeaderCellDef class="px-6 py-4 text-on-surface-variant">Sales</th>

        <td mat-cell *matCellDef="let redemption" class="p-6">
          @if (isLoading()) {
          <ngx-skeleton-loader [theme]="{
                height: '24px',
                width: '80px',
                margin: '0'
              }"></ngx-skeleton-loader>
          } @else {
          {{ redemption.getBaseOrderValue() | currency : organization()?.currency : 'symbol' }}
          }
        </td>
      </ng-container>

      <!-- Discount -->
      <ng-container matColumnDef="discount">
        <th mat-header-cell *matHeaderCellDef class="px-6 py-4 text-on-surface-variant">Discount</th>

        <td mat-cell *matCellDef="let redemption" class="p-6">
          @if (isLoading()) {
          <ngx-skeleton-loader [theme]="{
                height: '24px',
                width: '80px',
                margin: '0'
              }"></ngx-skeleton-loader>
          } @else {
          {{ redemption.getDiscount() | currency : organization()?.currency : 'symbol' }}
          }
        </td>
      </ng-container>

      <!-- Header -->
      <tr mat-header-row *matHeaderRowDef="columns"></tr>

      <!-- Rows -->
      <tr mat-row *matRowDef="let row; columns: columns"></tr>

      <!-- Empty State -->
      <tr class="empty-row" *matNoDataRow>
        <td [attr.colspan]="columns.length">
          <div class="flex flex-col justify-center items-center py-24 h-[500px]">
            <div class="flex flex-col items-center text-center space-y-4">
              <div class="flex justify-center items-center bg-surface-variant rounded-full p-4 shadow-sm">
                <mat-icon class="text-on-surface-variant text-2xl">payments</mat-icon>
              </div>

              <div>
                <p class="text-on-surface text-lg font-medium">No redemptions to show</p>

                <p class="text-on-surface-variant text-sm">There arenâ€™t any redemptions for this period.</p>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- PAGINATION -->
  @if (count()) {
  <mat-paginator [length]="count()
      " [pageIndex]="paginationOptions().pageIndex" [pageSize]="paginationOptions().pageSize"
    (page)="onPageChange($event)">
  </mat-paginator>
  }
</div>